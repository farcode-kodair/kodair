<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AirStore</title>
    <link rel="stylesheet" type="text/css" href="AirStore2.css">
    <script src="script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let allAppsData = [];
        let options = {
            method: 'GET',
            headers: {
                'xc-token': ''
            }
        };

        async function fetchCSVData() {
            try {
                const response = await fetch('https://res.cloudinary.com/kodair/raw/upload/Airstore/airstore.csv');
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                const csvData = await response.text();
                const jsonData = Papa.parse(csvData, { header: true }).data;
                return jsonData;
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchTotalCount() {
            try {
                const response = await fetch('https://app.nocodb.com/api/v1/db/data/noco/phgforxa020gg7q/ml1ww2bojawn3mf/views/vwy72p5sijrhvnmg/count', options);
                if (!response.ok) {
                    throw new Error('Failed to fetch total count');
                }
                const data = await response.json();
                return data.count;
            } catch (error) {
                console.error(error);
                return -1; // Return -1 to indicate an error
            }
        }

        async function fetchData(offset, limit) {
            try {
                const response = await fetch(`https://app.nocodb.com/api/v1/db/data/noco/phgforxa020gg7q/ml1ww2bojawn3mf/views/vwy72p5sijrhvnmg?offset=${offset}&limit=${limit}&where=(Public,eq,true)`, options);
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                const data = await response.json();
                return data.list;
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchAllNocoDBData() {
            const limit = 100; // Number of items per fetch
            let offset = 0;
            let allData = [];
            const totalCount = await fetchTotalCount(); // Fetch total count

            if (totalCount === -1) {
                console.error('Failed to fetch total count. Aborting data fetch.');
                return [];
            }

            try {
                while (offset < totalCount) {
                    const partialData = await fetchData(offset, limit);
                    if (!Array.isArray(partialData) || partialData.length === 0) break; // Exit loop if no more data
                    allData = allData.concat(partialData);
                    offset += limit;
                }

                return allData;
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function initializeApp() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', handleSearch);
            
            allAppsData = await fetchCSVData();
            displayApps(allAppsData);
        }

        async function handleSearch() {
            const searchInput = document.getElementById('searchInput').value;
            const nocodbMatch = searchInput.match(/^Nocodb:\s*([^ ]+)\s*(.*)$/i);

            if (nocodbMatch) {
                const apiKey = nocodbMatch[1].trim();
                const searchTerm = nocodbMatch[2].trim();
                options.headers['xc-token'] = apiKey;
                allAppsData = await fetchAllNocoDBData();
                displayApps(allAppsData);
                searchApps(searchTerm); // Search within NocoDB data
            } else {
                allAppsData = await fetchCSVData();
                displayApps(allAppsData);
                searchApps(searchInput); // Search within CSV data
            }
        }

        function displayApps(appsList) {
            document.querySelectorAll('.Category').forEach(category => category.remove());

            if (appsList.length === 0) {
                const errorMessage = document.createElement('div');
                errorMessage.innerText = 'Failed to fetch data. Please try again later.';
                document.body.appendChild(errorMessage);
                return;
            }

            const categories = {};

            appsList.forEach(app => {
                const category = app.Category;
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(app);
            });

            Object.entries(categories).forEach(([category, apps]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('Category');

                const categoryTitle = document.createElement('div');
                categoryTitle.classList.add('CategoryTitle');
                categoryTitle.innerText = category;

                const categoryContainer = document.createElement('div');
                categoryContainer.classList.add('CategoryApps');

                apps.forEach(app => {
                    const appElement = document.createElement('div');
                    appElement.classList.add('AirApp');
                    appElement.setAttribute('data-title', app.Title.toLowerCase());
                    appElement.setAttribute('data-description', app.Description.toLowerCase());
                    appElement.setAttribute('onclick', `changeAppUniversal('${app.URL}')`);

                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                    svg.setAttribute('aria-hidden', 'true');
                    svg.setAttribute('role', 'img');
                    svg.setAttribute('width', '3.75em');
                    svg.setAttribute('height', '3.75em');
                    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

                    svg.innerHTML = app.SVG;

                    const titleDescContainer = document.createElement('div');
                    titleDescContainer.classList.add('AppTitle');
                    titleDescContainer.innerHTML = `${app.Title}<br><span class="desc">${app.Description}</span>`;

                    appElement.appendChild(svg);
                    appElement.appendChild(titleDescContainer);
                    categoryContainer.appendChild(appElement);
                });

                categoryDiv.appendChild(categoryTitle);
                categoryDiv.appendChild(categoryContainer);
                document.body.appendChild(categoryDiv);
            });
        }

        function searchApps(searchTerm) {
            const searchInput = searchTerm.toLowerCase();
            const allApps = document.querySelectorAll('.AirApp');
            allApps.forEach(app => {
                const title = app.getAttribute('data-title');
                const description = app.getAttribute('data-description');
                if (title.includes(searchInput) || description.includes(searchInput)) {
                    app.style.display = 'inline-block'; // show app if it matches search
                } else {
                    app.style.display = 'none'; // hide app if it does not match search
                }
            });

            const allCategories = document.querySelectorAll('.Category');
            allCategories.forEach(category => {
                const categoryApps = category.querySelectorAll('.AirApp');
                let anyVisible = false;
                categoryApps.forEach(app => {
                    if (app.style.display !== 'none') {
                        anyVisible = true;
                    }
                });
                if (anyVisible) {
                    category.style.display = 'block'; // show category if any app inside is visible
                } else {
                    category.style.display = 'none'; // hide category if no app inside is visible
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</head>
<body>
    <input type="text" id="searchInput" placeholder="Search...">
</body>
</html>